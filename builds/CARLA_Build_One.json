{
  // CARLA_Build_One_Final.json
  // Purpose: Complete Google Calendar → Checkfront sync flow with logging, hold detection, and calendar event translation.

  "meta": {
    "version": "1.0.0-final",
    "description": "Calendar to Checkfront automation with HOLD detection and Discord logs",
    "status": "active",
    "includes": [
      "Google Calendar Trigger",
      "Studio + SKU Mapper",
      "Checkfront Booking Creator",
      "HOLD Booking Logic",
      "Discord Sync Log Output"
    ]
  },

  "triggers": [
    {
      "type": "Google Calendar Trigger",
      "studioCalendars": [
        {
          "calendarId": "c_706e1925cfb58390b4e734997a4ef4db43ac60bddfb5af2e680a36c43c70e903@group.calendar.google.com",
          "sku": "studio-b",
          "checkfrontId": 99834
        },
        {
          "calendarId": "c_259b4683777c9096f9c69f9ee334f7dfce523bf78094446db6b75471c9594d7d@group.calendar.google.com",
          "sku": "studio-a",
          "checkfrontId": 5288
        }
        // ... Add other studios here
      ],
      "detect": ["create", "update", "cancel"]
    }
  ],

  "actions": [
    {
      "name": "Normalize Incoming Event",
      "type": "Function",
      "code": "// Extract date, time, attendee, description, and HOLD detection\nreturn items.map(item => {\n  const summary = item.json.summary || '';\n  const isHold = summary.toLowerCase().includes('hold');\n  const start = item.json.start.dateTime;\n  const end = item.json.end.dateTime;\n\n  return {\n    json: {\n      ...item.json,\n      studio: 'Studio B', // Replace with logic later\n      sku: 'studio-b',\n      checkfrontId: 99834,\n      isHold,\n      startDate: start.split('T')[0],\n      startTime: start.split('T')[1].slice(0,5),\n      endTime: end.split('T')[1].slice(0,5)\n    }\n  };\n});"
    },

    {
      "name": "Check for HOLD",
      "type": "Switch",
      "rules": [
        {
          "value1": "={{$json[\"isHold\"]}}",
          "operation": "equal",
          "value2": true
        }
      ],
      "outputs": [
        "CreateHoldBooking",
        "CreateConfirmedBooking"
      ]
    },

    {
      "name": "CreateConfirmedBooking",
      "type": "HTTP Request",
      "method": "POST",
      "url": "https://centra-studios.manage.na1.bookingplatform.app/api/3.0/booking/create",
      "headers": {
        "X-APP-APIKEY": "YOUR_API_KEY_HERE"
      },
      "jsonBody": {
        "items": {
          "={{$json[\"checkfrontId\"]}}": {
            "qty": 1,
            "date": "={{$json[\"startDate\"]}}",
            "start_time": "={{$json[\"startTime\"]}}",
            "end_time": "={{$json[\"endTime\"]}}"
          }
        },
        "customer": {
          "first_name": "Unknown",
          "last_name": "Client",
          "email": "hello@centrastudios.com"
        },
        "status": "PEND"
      }
    },

    {
      "name": "CreateHoldBooking",
      "type": "HTTP Request",
      "method": "POST",
      "url": "https://centra-studios.manage.na1.bookingplatform.app/api/3.0/booking/create",
      "headers": {
        "X-APP-APIKEY": "YOUR_API_KEY_HERE"
      },
      "jsonBody": {
        "items": {
          "={{$json[\"checkfrontId\"]}}": {
            "qty": 1,
            "date": "={{$json[\"startDate\"]}}",
            "start_time": "={{$json[\"startTime\"]}}",
            "end_time": "={{$json[\"endTime\"]}}"
          }
        },
        "customer": {
          "first_name": "HOLD",
          "last_name": "Request",
          "email": "hello@centrastudios.com"
        },
        "status": "HOLD"
      }
    },

    {
      "name": "Send to Discord Log",
      "type": "Discord",
      "credentials": "Discord API",
      "channelId": "1361740873334919299",
      "message": "New event processed → {{$json.summary}} | Status: {{$json.status}} | Studio: {{$json.studio}}"
    }
  ]
}
